<!--


   SSSSSSSSSSSSSSS TTTTTTTTTTTTTTTTTTTTTTT     OOOOOOOOO     PPPPPPPPPPPPPPPPP
 SS:::::::::::::::ST:::::::::::::::::::::T   OO:::::::::OO   P::::::::::::::::P
S:::::SSSSSS::::::ST:::::::::::::::::::::T OO:::::::::::::OO P::::::PPPPPP:::::P
S:::::S     SSSSSSST:::::TT:::::::TT:::::TO:::::::OOO:::::::OPP:::::P     P:::::P
S:::::S            TTTTTT  T:::::T  TTTTTTO::::::O   O::::::O  P::::P     P:::::P
S:::::S                    T:::::T        O:::::O     O:::::O  P::::P     P:::::P
 S::::SSSS                 T:::::T        O:::::O     O:::::O  P::::PPPPPP:::::P
  SS::::::SSSSS            T:::::T        O:::::O     O:::::O  P:::::::::::::PP
    SSS::::::::SS          T:::::T        O:::::O     O:::::O  P::::PPPPPPPPP
       SSSSSS::::S         T:::::T        O:::::O     O:::::O  P::::P
            S:::::S        T:::::T        O:::::O     O:::::O  P::::P
            S:::::S        T:::::T        O::::::O   O::::::O  P::::P
SSSSSSS     S:::::S      TT:::::::TT      O:::::::OOO:::::::OPP::::::PP
S::::::SSSSSS:::::S      T:::::::::T       OO:::::::::::::OO P::::::::P
S:::::::::::::::SS       T:::::::::T         OO:::::::::OO   P::::::::P
 SSSSSSSSSSSSSSS         TTTTTTTTTTT           OOOOOOOOO     PPPPPPPPPP


 Do not edit this file directly. It is generally programatically by `jsdoc2md`

 If you'd like to make a change to the docs, do so by editing the comments in the source code.

 Pull requests for changes to this file will be rejected!

-->
# Contents

## Classes

<dl>
<dt><a href="#Client">Client</a></dt>
<dd><p>A client connection handle for interacting with the faktory server. Holds a pool of 1 or more
underlying connections. Safe for concurrent use and tolerant of unexpected
connection terminations. Use this object for all interactions with the factory server.</p>
</dd>
<dt><a href="#Job">Job</a></dt>
<dd><p>A class wrapping a <a href="#external_JobPayload">JobPayload</a></p>
</dd>
<dt><a href="#Worker">Worker</a></dt>
<dd><p>Representation of a worker process with many concurrent job processors. Works at the
concurrency set in options during construction. Will hold at most <code>concurrency</code> jobs
in-memory while processing at any one time. Listens for signals to quiet or shutdown.
Should not be started more than once per-process, nor should more than one worker be
started per-process.</p>
</dd>
</dl>

## Typedefs

<dl>
<dt><a href="#JobThunk">JobThunk</a> : <code>function</code></dt>
<dd><p>A function returned by a job function that will be called with the job context as its
only argument and awaited. This exists to allow you to define simple job functions that
only accept their job args, but in many cases you might need the job&#39;s custom properties
or stateful connections (like a database connection) in your job and want to attach
a connection for your job function to use without having to create it itself.</p>
</dd>
<dt><a href="#Context">Context</a> : <code>object</code></dt>
<dd><p>A context object passed through middleware and to a job thunk</p>
</dd>
<dt><a href="#Registry">Registry</a> : <code>Object.&lt;Jobtype, JobFunction&gt;</code></dt>
<dd><p>A lookup table holding the jobtype constants mapped to their job functions</p>
</dd>
<dt><a href="#Command">Command</a> : <code>Array.&lt;string&gt;</code></dt>
<dd><p>A command to send the server in array form</p>
</dd>
</dl>

## External

<dl>
<dt><a href="#external_Jobtype">Jobtype</a> : <code>string</code></dt>
<dd><p>Discriminator used by a worker to decide how to execute a job. This will be the name you
used during register.</p>
</dd>
<dt><a href="#external_timestamp">timestamp</a> : <code>string</code></dt>
<dd><p>An RFC3339-format datetime string</p>
</dd>
<dt><a href="#external_JobPayload">JobPayload</a> : <code>object</code></dt>
<dd><p>A work unit that can be scheduled by the faktory work server and executed by clients</p>
</dd>
<dt><a href="#external_JobFunction">JobFunction</a> : <code>function</code></dt>
<dd><p>A function that executes work</p>
</dd>
<dt><a href="#external_HI">HI</a> : <code>object</code></dt>
<dd><p>An after-connect initial message from the server to handshake the connection</p>
</dd>
<dt><a href="#external_HELLO">HELLO</a> : <code>object</code></dt>
<dd><p>The client&#39;s response to the server&#39;s <a href="HI">HI</a> to initiate a connection</p>
</dd>
</dl>

# API

<a name="Client"></a>

## Client
A client connection handle for interacting with the faktory server. Holds a pool of 1 or more
underlying connections. Safe for concurrent use and tolerant of unexpected
connection terminations. Use this object for all interactions with the factory server.

**Kind**: global class  

* [Client](#Client)
    * [new Client([options])](#new_Client_new)
    * [.connect()](#Client+connect) ⇒ <code>Promise</code>
    * [.close()](#Client+close) ⇒ <code>undefined</code>
    * [.job(jobtype, ...args)](#Client+job) ⇒ [<code>Job</code>](#Job)
    * [.send(...args)](#Client+send)
    * [.fetch(...queues)](#Client+fetch) ⇒ <code>Object</code> \| <code>null</code>
    * [.beat()](#Client+beat) ⇒ <code>String</code>
    * [.push(job)](#Client+push) ⇒ <code>String</code>
    * [.flush()](#Client+flush) ⇒ <code>Promise</code>
    * [.info()](#Client+info) ⇒ <code>Object</code>
    * [.ack(jid)](#Client+ack) ⇒ <code>String</code>
    * [.fail(jid, e)](#Client+fail) ⇒ <code>String</code>

<a name="new_Client_new"></a>

### new Client([options])
Creates a Client with a connection pool


| Param | Type | Default | Description |
| --- | --- | --- | --- |
| [options] | <code>object</code> |  |  |
| [options.url] | <code>string</code> | <code>&quot;tcp://localhost:7419&quot;</code> | connection string for the faktory server                                                    (checks for FAKTORY_PROVIDER and                                                    FAKTORY_URL) |
| [options.host] | <code>string</code> | <code>&quot;localhost&quot;</code> | host string to connect to |
| [options.port] | <code>number</code> \| <code>string</code> | <code>7419</code> | port to connect to faktory server on |
| [options.password] | <code>string</code> |  | faktory server password to use during HELLO |
| [options.wid] | <code>string</code> |  | optional wid that should be provided to the server                               (only necessary for a worker process consuming jobs) |
| [options.labels] | <code>Array.&lt;string&gt;</code> | <code>[]</code> | optional labels to provide the faktory server                                       for this client |
| [options.poolSize] | <code>number</code> | <code>10</code> | the maxmimum size of the connection pool |

**Example**  
```js
const client = new Client();

const job = await client.fetch('default');
```
<a name="Client+connect"></a>

### client.connect() ⇒ <code>Promise</code>
Explicitly opens a connection and then closes it to test connectivity.
Under normal circumstances you don't need to call this method as all of the
communication methods will check out a connection before executing. If a connection is
not available, one will be created. This method exists to ensure connection is possible
if you need to do so. You can think of this like [sqlx#MustConnect](https://godoc.org/github.com/jmoiron/sqlx#MustConnect)

**Kind**: instance method of [<code>Client</code>](#Client)  
**Returns**: <code>Promise</code> - resolves when a connection is opened  
<a name="Client+close"></a>

### client.close() ⇒ <code>undefined</code>
Closes the connection to the server

**Kind**: instance method of [<code>Client</code>](#Client)  
<a name="Client+job"></a>

### client.job(jobtype, ...args) ⇒ [<code>Job</code>](#Job)
Creates a new Job object to build a job payload

**Kind**: instance method of [<code>Client</code>](#Client)  
**Returns**: [<code>Job</code>](#Job) - a job builder with attached Client for PUSHing  
**See**: Job  

| Param | Type | Description |
| --- | --- | --- |
| jobtype | <code>String</code> | name of the job function |
| ...args | <code>\*</code> | arguments to the job function |

<a name="Client+send"></a>

### client.send(...args)
Borrows a connection from the connection pool, forwards all arguments to
[Connection.send](Connection.send), and checks the connection back into the pool when
the promise returned by the wrapped function is resolved or rejected.

**Kind**: instance method of [<code>Client</code>](#Client)  
**See**: Connection.send  

| Param | Type | Description |
| --- | --- | --- |
| ...args | <code>\*</code> | arguments to [Connection.send](Connection.send) |

<a name="Client+fetch"></a>

### client.fetch(...queues) ⇒ <code>Object</code> \| <code>null</code>
Fetches a job payload from the server from one of ...queues

**Kind**: instance method of [<code>Client</code>](#Client)  
**Returns**: <code>Object</code> \| <code>null</code> - a job payload if one is available, otherwise null  

| Param | Type | Description |
| --- | --- | --- |
| ...queues | <code>String</code> | list of queues to pull a job from |

<a name="Client+beat"></a>

### client.beat() ⇒ <code>String</code>
Sends a heartbeat for this.wid to the server

**Kind**: instance method of [<code>Client</code>](#Client)  
**Returns**: <code>String</code> - string 'OK' when the heartbeat is accepted, otherwise
                          may return a state string when the server has a signal
                          to send this client (`quiet`, `terminate`)  
<a name="Client+push"></a>

### client.push(job) ⇒ <code>String</code>
Pushes a job payload to the server

**Kind**: instance method of [<code>Client</code>](#Client)  
**Returns**: <code>String</code> - the jid for the pushed job  

| Param | Type | Description |
| --- | --- | --- |
| job | [<code>Job</code>](#Job) \| <code>Object</code> | job payload to push |

<a name="Client+flush"></a>

### client.flush() ⇒ <code>Promise</code>
Sends a FLUSH to the server

**Kind**: instance method of [<code>Client</code>](#Client)  
**Returns**: <code>Promise</code> - resolves with the server's response text  
<a name="Client+info"></a>

### client.info() ⇒ <code>Object</code>
Sends an INFO command to the server

**Kind**: instance method of [<code>Client</code>](#Client)  
**Returns**: <code>Object</code> - the server's INFO response object  
<a name="Client+ack"></a>

### client.ack(jid) ⇒ <code>String</code>
Sends an ACK to the server for a particular job ID

**Kind**: instance method of [<code>Client</code>](#Client)  
**Returns**: <code>String</code> - the server's response text  

| Param | Type | Description |
| --- | --- | --- |
| jid | <code>String</code> | the jid of the job to acknowledge |

<a name="Client+fail"></a>

### client.fail(jid, e) ⇒ <code>String</code>
Sends a FAIL command to the server for a particular job ID with error information

**Kind**: instance method of [<code>Client</code>](#Client)  
**Returns**: <code>String</code> - the server's response text  

| Param | Type | Description |
| --- | --- | --- |
| jid | <code>String</code> | the jid of the job to FAIL |
| e | <code>Error</code> | an error object that caused the job to fail |

<a name="Job"></a>

## Job
A class wrapping a [JobPayload](#external_JobPayload)

**Kind**: global class  

* [Job](#Job)
    * [new Job(jobtype, [client])](#new_Job_new)
    * _instance_
        * [.jid](#Job+jid)
        * [.queue](#Job+queue)
        * [.args](#Job+args)
        * [.priority](#Job+priority)
        * [.retry](#Job+retry)
        * [.at](#Job+at)
        * [.reserveFor](#Job+reserveFor)
        * [.custom](#Job+custom)
        * [.toJSON()](#Job+toJSON) ⇒ <code>object</code>
        * [.push()](#Job+push) ⇒ <code>string</code>
    * _static_
        * [.jid()](#Job.jid) ⇒ <code>string</code>

<a name="new_Job_new"></a>

### new Job(jobtype, [client])
Creates a job


| Param | Type | Description |
| --- | --- | --- |
| jobtype | <code>string</code> | [Jobtype](#external_Jobtype) string |
| [client] | [<code>Client</code>](#Client) | a client to use for communicating to the server (if calling push) |

**Example**  
```js
// with a client
const client = await faktory.connect();
const job = client.job('SendWelcomeEmail', id);
```
**Example**  
```js
const Job = require('faktory/lib/job');
// without a client
const job = new Job('SendWelcomeEmail');
job.args = [id];
job.queue = 'mailers';
console.log(job.toJSON());
```
<a name="Job+jid"></a>

### job.jid
sets the jid

**Kind**: instance property of [<code>Job</code>](#Job)  
**See**: external:JobPayload  

| Param | Type | Description |
| --- | --- | --- |
| value | <code>string</code> | the >8 length jid |

<a name="Job+queue"></a>

### job.queue
sets the queue

**Kind**: instance property of [<code>Job</code>](#Job)  
**See**: external:JobPayload  

| Param | Type | Description |
| --- | --- | --- |
| value | <code>string</code> | queue name |

<a name="Job+args"></a>

### job.args
sets the args

**Kind**: instance property of [<code>Job</code>](#Job)  
**See**: external:JobPayload  

| Param | Type | Description |
| --- | --- | --- |
| value | <code>Array</code> | array of positional arguments |

<a name="Job+priority"></a>

### job.priority
sets the priority of this job

**Kind**: instance property of [<code>Job</code>](#Job)  
**See**: external:JobPayload  

| Param | Type | Description |
| --- | --- | --- |
| value | <code>number</code> | 0-9 |

<a name="Job+retry"></a>

### job.retry
sets the retry count

**Kind**: instance property of [<code>Job</code>](#Job)  
**See**: external:JobPayload  

| Param | Type | Description |
| --- | --- | --- |
| value | <code>number</code> | {@see external:JobPayload} |

<a name="Job+at"></a>

### job.at
sets the scheduled time

**Kind**: instance property of [<code>Job</code>](#Job)  
**See**: external:JobPayload  

| Param | Type | Description |
| --- | --- | --- |
| value | <code>Date</code> \| <code>string</code> | the date object or RFC3339 timestamp string |

<a name="Job+reserveFor"></a>

### job.reserveFor
sets the reserveFor parameter

**Kind**: instance property of [<code>Job</code>](#Job)  
**See**: external:JobPayload  

| Param | Type |
| --- | --- |
| value | <code>number</code> | 

<a name="Job+custom"></a>

### job.custom
sets the custom object property

**Kind**: instance property of [<code>Job</code>](#Job)  
**See**: external:JobPayload  

| Param | Type | Description |
| --- | --- | --- |
| value | <code>object</code> | the custom data |

<a name="Job+toJSON"></a>

### job.toJSON() ⇒ <code>object</code>
Generates an object from this instance for transmission over the wire

**Kind**: instance method of [<code>Job</code>](#Job)  
**Returns**: <code>object</code> - the job as a serializable javascript object  
**Link**: external:JobPayload|JobPayload}  
**See**: external:JobPayload  
<a name="Job+push"></a>

### job.push() ⇒ <code>string</code>
Pushes this job to the faktory server. Modifications after this point are not
persistable to the server

**Kind**: instance method of [<code>Job</code>](#Job)  
**Returns**: <code>string</code> - return of client.push(job)  
<a name="Job.jid"></a>

### Job.jid() ⇒ <code>string</code>
generates a uuid

**Kind**: static method of [<code>Job</code>](#Job)  
**Returns**: <code>string</code> - a uuid/v4 string  
<a name="Worker"></a>

## Worker
Representation of a worker process with many concurrent job processors. Works at the
concurrency set in options during construction. Will hold at most `concurrency` jobs
in-memory while processing at any one time. Listens for signals to quiet or shutdown.
Should not be started more than once per-process, nor should more than one worker be
started per-process.

**Kind**: global class  

* [Worker](#Worker)
    * [new Worker([options])](#new_Worker_new)
    * [.inProgress](#Worker+inProgress) ⇒ <code>array</code>
    * [.work()](#Worker+work) ⇒ [<code>Worker</code>](#Worker)
    * [.quiet()](#Worker+quiet) ⇒ <code>undefined</code>
    * [.stop()](#Worker+stop) ⇒ <code>promise</code>

<a name="new_Worker_new"></a>

### new Worker([options])

| Param | Type | Default | Description |
| --- | --- | --- | --- |
| [options] | <code>object</code> |  |  |
| [options.wid] | <code>String</code> | <code>uuid().slice(0, 8)</code> | the wid the worker will use |
| [options.concurrency] | <code>Number</code> | <code>20</code> | how many jobs this worker can process at once |
| [options.shutdownTimeout] | <code>Number</code> | <code>8</code> | the amount of time in seconds that the worker                                             may take to finish a job before exiting                                             ungracefully |
| [options.beatInterval] | <code>Number</code> | <code>15</code> | the amount of time in seconds between each                                             heartbeat |
| [options.queues] | <code>Array.&lt;string&gt;</code> | <code>[&#x27;default&#x27;]</code> | the queues this worker will fetch jobs from |
| [options.middleware] | <code>Array.&lt;function()&gt;</code> | <code>[]</code> | a set of middleware to run before performing                                               each job                                       in koa.js-style middleware execution signature |
| [options.registry] | [<code>Registry</code>](#Registry) | <code>Registry</code> | the job registry to use when working |

**Example**  
```js
const worker = new Worker({
  queues: ['critical', 'default', 'low'],
});

worker.work();
```
<a name="Worker+inProgress"></a>

### worker.inProgress ⇒ <code>array</code>
Returns an array of ids of processors with a job currently in progress

**Kind**: instance property of [<code>Worker</code>](#Worker)  
**Returns**: <code>array</code> - array of processor ids  
<a name="Worker+work"></a>

### worker.work() ⇒ [<code>Worker</code>](#Worker)
starts the worker fetch loop and job processing

**Kind**: instance method of [<code>Worker</code>](#Worker)  
**Returns**: [<code>Worker</code>](#Worker) - self, when working has been stopped by a signal or concurrent
                       call to stop or quiet  
**See**

- Worker.quiet
- Worker.stop

<a name="Worker+quiet"></a>

### worker.quiet() ⇒ <code>undefined</code>
Signals to the worker to discontinue fetching new jobs and allows the worker
to continue processing any currently-running jobs

**Kind**: instance method of [<code>Worker</code>](#Worker)  
<a name="Worker+stop"></a>

### worker.stop() ⇒ <code>promise</code>
stops the worker

**Kind**: instance method of [<code>Worker</code>](#Worker)  
**Returns**: <code>promise</code> - resolved when worker stops  
<a name="JobThunk"></a>

## JobThunk : <code>function</code>
A function returned by a job function that will be called with the job context as its
only argument and awaited. This exists to allow you to define simple job functions that
only accept their job args, but in many cases you might need the job's custom properties
or stateful connections (like a database connection) in your job and want to attach
a connection for your job function to use without having to create it itself.

**Kind**: global typedef  
**See**: Context  

| Param | Type | Description |
| --- | --- | --- |
| ctx | <code>object</code> | context object containing the job and any other data attached                     via userland-middleware |

**Example**  
```js
// assumes you have middleware that attaches `db` to `ctx`

faktory.register('UserWelcomer', (...args) => (ctx) => {
  const [ id ] = args;
  const user = await ctx.db.users.find(id);
  const email = new WelcomeEmail(user);
  await email.deliver();
});
```
<a name="Context"></a>

## Context : <code>object</code>
A context object passed through middleware and to a job thunk

**Kind**: global typedef  
**Properties**

| Name | Type | Description |
| --- | --- | --- |
| Context.job | <code>object</code> | the job payload |
| Context.fn | <code>function</code> | a reference to the job function |

<a name="Registry"></a>

## Registry : <code>Object.&lt;Jobtype, JobFunction&gt;</code>
A lookup table holding the jobtype constants mapped to their job functions

**Kind**: global typedef  
**See**

- external:Jobtype
- external:JobFunction

**Example**  
```js
{
  SendWelcomeUser: (id) => {
    // job fn
  },
  GenerateThumbnail: (id, size) => {
    // job fn
  }
}
```
<a name="Command"></a>

## Command : <code>Array.&lt;string&gt;</code>
A command to send the server in array form

**Kind**: global typedef  
**Example**  
```js
// multiple string arguments
['FETCH', 'critical', 'default']

// json string as an argument
['PUSH', '{"jid": "123"}']

// single string argument
['ACK', '123']
```
<a name="external_Jobtype"></a>

## Jobtype : <code>string</code>
Discriminator used by a worker to decide how to execute a job. This will be the name you
used during register.

**Kind**: global external  
**See**: [https://github.com/contribsys/faktory/wiki/The-Job-Payload](https://github.com/contribsys/faktory/wiki/The-Job-Payload)  
**Example**  
```js
// where `MyFunction` is the jobtype

faktory.register('MyFunction', () => {})
```
<a name="external_timestamp"></a>

## timestamp : <code>string</code>
An RFC3339-format datetime string

**Kind**: global external  
**Example**  
```js
"2002-10-02T10:00:00-05:00"
"2002-10-02T15:00:00Z"
"2002-10-02T15:00:00.05Z"

new Date().toISOString();
// => '2019-02-11T15:59:15.593Z'
```
<a name="external_JobPayload"></a>

## JobPayload : <code>object</code>
A work unit that can be scheduled by the faktory work server and executed by clients

**Kind**: global external  
**See**

- [https://github.com/contribsys/faktory/wiki/The-Job-Payload](https://github.com/contribsys/faktory/wiki/The-Job-Payload)
- [Faktory Protocol Specification - Work Units](https://github.com/contribsys/faktory/blob/master/docs/protocol-specification.md#work-units)

**Properties**

| Name | Type | Default | Description |
| --- | --- | --- | --- |
| [jid] | <code>string</code> | <code>&quot;uuid()&quot;</code> | globally unique ID for the job. |
| jobtype | [<code>Jobtype</code>](#external_Jobtype) |  |  |
| [queue] | <code>string</code> | <code>&quot;default&quot;</code> | which job queue to push this job onto. |
| [args] | <code>array</code> | <code>[]</code> | parameters the worker should use when executing the job. |
| [priority] | <code>number</code> | <code>5</code> | higher priority jobs are dequeued before lower priority jobs. |
| [retry] | <code>number</code> | <code>25</code> | number of times to retry this job if it fails. 0 discards the                               failed job, -1 saves the failed job to the dead set. |
| [at] | [<code>timestamp</code>](#external_timestamp) |  | run the job at approximately this time; immediately if blank |
| [reserve_for] | <code>number</code> | <code>1800</code> | number of seconds a job may be held by a worker before it                                       is considered failed. |
| custom | <code>object</code> |  | provides additional context to the worker executing the job. |

<a name="external_JobFunction"></a>

## JobFunction : <code>function</code>
A function that executes work

**Kind**: global external  

| Param | Type | Description |
| --- | --- | --- |
| ...args | <code>\*</code> | arguments from the job payload |

**Example**  
```js
function(...args) {
  // does something meaningful
}
```
<a name="external_HI"></a>

## HI : <code>object</code>
An after-connect initial message from the server to handshake the connection

**Kind**: global external  
**See**: external:HELLO  
**Properties**

| Name | Type | Description |
| --- | --- | --- |
| v | <code>number</code> | faktory server protocol version number |
| i | <code>number</code> | only present when password is required. number of password hash iterations.                      see [HELLO](HELLO). |
| s | <code>string</code> | only present when password is required. salt for password hashing.                      see [HELLO](HELLO). |

<a name="external_HELLO"></a>

## HELLO : <code>object</code>
The client's response to the server's [HI](HI) to initiate a connection

**Kind**: global external  
**See**

- external:HI
- [Faktory Protocol Specification](https://github.com/contribsys/faktory/blob/master/docs/protocol-specification.md)

**Properties**

| Name | Type | Description |
| --- | --- | --- |
| v | <code>string</code> | the faktory client protocol version |
| hostname | <code>string</code> | name of the host that is running this worker |
| wid | <code>string</code> | globally unique identifier for this worker |
| pid | <code>number</code> | local process identifier for this worker on its host |
| labels | <code>Array.&lt;string&gt;</code> | labels that apply to this worker, to allow producers to target work                             units to worker types. |
| pwdhash | <code>string</code> | This field should be the hexadecimal representation of the ith                            SHA256 hash of the client password concatenated with the value in s. |

